<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Baraka POS</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase.js"></script>

<style>

/* ========================= THEME ========================= */

:root {
  --bg:#0b1220;
  --sidebar:#0f172a;
  --card:#111827;
  --border:rgba(255,255,255,0.06);
  --primary:#10b981;
  --text:#ffffff;
  --text-soft:#94a3b8;
  --danger:#ef4444;
}

.light {
  --bg:#f3f4f6;
  --sidebar:#e5e7eb;
  --card:#ffffff;
  --border:rgba(0,0,0,0.06);
  --primary:#10b981;
  --text:#111827;
  --text-soft:#6b7280;
  --danger:#ef4444;
}

*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
}

body{
  background:var(--bg);
  color:var(--text);
  display:flex;
  height:100vh;
  overflow:hidden;
}

/* ========================= SIDEBAR ========================= */

.sidebar{
  width:250px;
  background:var(--sidebar);
  border-right:1px solid var(--border);
  padding:30px 20px;
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}

.logo{
  font-size:22px;
  font-weight:700;
  margin-bottom:40px;
}

.nav-btn{
  background:none;
  border:none;
  color:var(--text-soft);
  padding:12px 15px;
  border-radius:8px;
  text-align:left;
  cursor:pointer;
  transition:.2s;
  margin-bottom:8px;
}

.nav-btn:hover{
  background:rgba(16,185,129,.1);
  color:var(--primary);
}

.nav-btn.active{
  background:rgba(16,185,129,.15);
  color:var(--primary);
  font-weight:600;
}

/* ========================= MAIN ========================= */

.main{
  flex:1;
  padding:40px 60px;
  overflow-y:auto;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:40px;
}

.card{
  background:var(--card);
  padding:20px;
  border-radius:14px;
  border:1px solid var(--border);
  margin-bottom:20px;
  transition:.25s;
}

.card:hover{
  transform:translateY(-4px);
}

.stat-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
  gap:20px;
}

.input{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:transparent;
  color:var(--text);
  margin-bottom:10px;
}

.button{
  background:var(--primary);
  border:none;
  padding:10px 16px;
  border-radius:8px;
  color:white;
  cursor:pointer;
  transition:.2s;
}

.button:hover{
  opacity:.9;
}

.hidden{
  display:none;
}

/* POS Layout */
.pos-layout{
  display:grid;
  grid-template-columns:2fr 1fr;
  gap:25px;
}

.pos-products{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
  gap:15px;
}

.pos-item{
  cursor:pointer;
  text-align:center;
}

/* ========================= AUTH ========================= */

.auth-container{
  width:360px;
  margin:auto;
  background:var(--card);
  padding:40px;
  border-radius:16px;
  border:1px solid var(--border);
}

</style>
</head>

<body>

<!-- AUTH -->
<div id="authPage" class="auth-container">
  <h2 style="margin-bottom:20px;">Baraka POS</h2>
  <input id="email" class="input" placeholder="Email">
  <input id="password" class="input" type="password" placeholder="Parol">
  <button class="button" onclick="register()">Ro‘yxatdan o‘tish</button>
  <button class="button" onclick="login()" style="margin-top:10px;">Kirish</button>
</div>

<!-- APP -->
<div id="app" class="hidden" style="display:flex;width:100%;">

  <div class="sidebar">
    <div>
      <div class="logo">Baraka</div>
      <button class="nav-btn active" onclick="showView('dashboard')">Dashboard</button>
      <button class="nav-btn" onclick="showView('products')">Mahsulotlar</button>
      <button class="nav-btn" onclick="showView('pos')">Sotish</button>
    </div>
    <div>
      <button class="nav-btn" onclick="toggleTheme()">Dark/Light</button>
      <button class="nav-btn" onclick="logout()">Chiqish</button>
    </div>
  </div>

  <div class="main">

    <div class="header">
      <h2 id="shopTitle">Xush kelibsiz</h2>
      <div id="userEmail"></div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboardView">
      <div class="stat-grid">
        <div class="card"><h3>Bugungi savdo</h3><h2 id="todayStat">0</h2></div>
        <div class="card"><h3>Haftalik savdo</h3><h2 id="weekStat">0</h2></div>
        <div class="card"><h3>Oylik savdo</h3><h2 id="monthStat">0</h2></div>
      </div>
    </div>

    <!-- PRODUCTS -->
    <div id="productsView" class="hidden">
      <div class="card">
        <h3>Mahsulot qo‘shish</h3>
        <input id="productName" class="input" placeholder="Nomi">
        <input id="productPrice" class="input" type="number" placeholder="Narxi">
        <input id="productStock" class="input" type="number" placeholder="Stock">
        <button class="button" onclick="addProduct()">Qo‘shish</button>
      </div>
      <div id="productList"></div>
    </div>

    <!-- POS -->
    <div id="posView" class="hidden">
      <div class="pos-layout">

        <div>
          <div class="card">
            <input id="posSearch" class="input" placeholder="Qidirish..." oninput="renderPOSProducts()">
          </div>
          <div id="posProductList" class="pos-products"></div>
        </div>

        <div>
          <div class="card">
            <h3>Savatcha</h3>
            <div id="cartList"></div>
            <hr style="margin:15px 0;border-color:var(--border)">
            <h3>Jami: <span id="cartTotal">0</span></h3>
            <button class="button" style="width:100%;" onclick="completeSale()">Sotuvni yakunlash</button>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>

<script>

/* ========================= VIEW ========================= */

function showView(view){
  document.querySelectorAll(".nav-btn").forEach(b=>b.classList.remove("active"));
  event.target.classList.add("active");

  ["dashboardView","productsView","posView"].forEach(v=>{
    document.getElementById(v).classList.add("hidden");
  });

  document.getElementById(view+"View").classList.remove("hidden");

  if(view==="pos") loadPOSProducts();
}

/* ========================= AUTH ========================= */

let currentUser=null;

function register(){
  auth.createUserWithEmailAndPassword(email.value,password.value);
}

function login(){
  auth.signInWithEmailAndPassword(email.value,password.value);
}

function logout(){
  auth.signOut();
}

auth.onAuthStateChanged(user=>{
  if(user){
    currentUser=user;
    authPage.classList.add("hidden");
    app.classList.remove("hidden");
    userEmail.innerText=user.email;
    listenProducts();
  }else{
    authPage.classList.remove("hidden");
    app.classList.add("hidden");
  }
});

/* ========================= PRODUCTS ========================= */

function addProduct(){
  db.collection("shops").doc(currentUser.uid).collection("products").add({
    name:productName.value,
    price:Number(productPrice.value),
    stock:Number(productStock.value)||0,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  productName.value="";
  productPrice.value="";
  productStock.value="";
}

function listenProducts(){
  db.collection("shops").doc(currentUser.uid)
  .collection("products")
  .onSnapshot(snapshot=>{
    productList.innerHTML="";
    snapshot.forEach(doc=>{
      const p=doc.data();
      productList.innerHTML+=`
        <div class="card">
          <strong>${p.name}</strong><br>
          ${p.price} so'm<br>
          Stock: ${p.stock||0}
        </div>`;
    });
  });
}

/* ========================= POS ========================= */

let posProducts=[];
let cart=[];

function loadPOSProducts(){
  db.collection("shops").doc(currentUser.uid)
  .collection("products")
  .onSnapshot(snapshot=>{
    posProducts=[];
    snapshot.forEach(doc=>{
      posProducts.push({id:doc.id,...doc.data()});
    });
    renderPOSProducts();
  });
}

function renderPOSProducts(){
  const search=(posSearch.value||"").toLowerCase();
  posProductList.innerHTML="";
  posProducts
    .filter(p=>p.name.toLowerCase().includes(search))
    .forEach(p=>{
      posProductList.innerHTML+=`
        <div class="card pos-item" onclick="addToCart('${p.id}')">
          <strong>${p.name}</strong><br>
          ${p.price} so'm<br>
          <small>Stock:${p.stock||0}</small>
        </div>`;
    });
}

function addToCart(id){
  const product=posProducts.find(p=>p.id===id);
  if(!product||product.stock<=0){alert("Stock yo'q");return;}
  const existing=cart.find(i=>i.id===id);
  if(existing){
    if(existing.quantity>=product.stock){alert("Yetarli stock yo'q");return;}
    existing.quantity++;
  }else{
    cart.push({...product,quantity:1});
  }
  renderCart();
}

function renderCart(){
  cartList.innerHTML="";
  let total=0;
  cart.forEach(item=>{
    total+=item.price*item.quantity;
    cartList.innerHTML+=`
      <div>
        ${item.name} x ${item.quantity}
        <button onclick="removeFromCart('${item.id}')">❌</button>
      </div>`;
  });
  cartTotal.innerText=total+" so'm";
}

function removeFromCart(id){
  cart=cart.filter(i=>i.id!==id);
  renderCart();
}

async function completeSale(){
  if(cart.length===0){alert("Savatcha bo'sh");return;}
  const total=cart.reduce((s,i)=>s+i.price*i.quantity,0);
  const batch=db.batch();
  const saleRef=db.collection("shops").doc(currentUser.uid)
    .collection("sales").doc();

  batch.set(saleRef,{
    items:cart,
    total,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });

  cart.forEach(item=>{
    const ref=db.collection("shops").doc(currentUser.uid)
      .collection("products").doc(item.id);
    batch.update(ref,{stock:item.stock-item.quantity});
  });

  await batch.commit();
  cart=[];
  renderCart();
  alert("Sotuv yakunlandi");
}

function toggleTheme(){
  document.body.classList.toggle("light");
}

</script>
</body>
</html>
